{% extends 'baykeshop/base_site.html' %}

{% block title %}{{ spu.title }}{% endblock %}

{% block extrastyle %}
    <style>
        [v-cloak] {
            display: none !important;
        }
        .is-active .al img {
            filter: grayscale(0%);
           /* border: solid 1px rebeccapurple;*/
        }
        .carousel{border: solid 1px rgba(224, 224, 224, 0.232);}
        .carousel-indicator{
            align-items: center;
            border-top: solid 1px rgba(224, 224, 224, 0.232);
            padding: 0;
            background-color: #fff;
        }
        .al img {
            filter: grayscale(100%);
        }
        
    </style>
{% endblock %}
    
{% block breadcrumb %}
<div class="container">
  <nav class="breadcrumb is-marginless mt-3 mb-3 is-small" aria-label="breadcrumbs">
    <ul>
      <li><a href="{% url 'baykeshop:home' %}">首页</a></li>
      <li><a href="{% url 'baykeshop:cate_detail' spu.category.first.parent.id %}">{{ spu.category.first.parent.name }}</a></li>
      <li><a href="{% url 'baykeshop:cate_detail' spu.category.first.id %}">{{ spu.category.first.name }}</a></li>
      <li class="is-active"><a href="#" aria-current="page">{{ spu.title }}</a></li>
    </ul>
  </nav>
</div>
{% endblock %}


{% block content %}
{{ skus|json_script:"skus-data" }}
{{ specs|json_script:"specs-data" }}
{{ current_ops|json_script:"current-ops-data" }}
<div class="container" id="spuDetail" v-cloak>
    <div class="columns">
        <div class="column is-3">
            <div class="box1 is-radiusless is-shadowless">
                <b-carousel :indicator-inside="false">
                    <b-carousel-item v-for="(item, i) in goods.banners" :key="i">
                        <b-image class="image" ratio="1by1" :src="getImgUrl(item)"></b-image>
                    </b-carousel-item>
                    <template #indicators="props">
                        <b-image class="al image" :src="getImgUrl(goods.banners[props.i])"></b-image>
                    </template>
                </b-carousel>
            </div>
        </div>
        <div class="column">
            <h1 class="is-size-5 has-text-justified">{{ spu.title }}</h1>
            <div class="box is-marginless is-radiusless has-background-primary-dark has-text-white-ter">
                <div class="is-flex is-justify-content-space-between is-align-items-center">
                    <div>
                        <span class=" is-size-7"> 原价：¥ <del>{$ goods.org_price $}</del></span>
                        <h1 class=" is-size-4">¥ {$ goods.price $}</h1>
                    </div>
                    <div class=" has-text-centered">
                        {$ goods.sales $}
                        <h1>销量</h1>
                    </div>
                </div>
            </div>

            <div class="box is-radiusless is-shadowless is-marginless" v-if="currentOps.length > 0" >
                <div class="is-flex is-flex-direction-column is-justify-content-space-around" style="min-height:80px">
                    <div class="is-flex" v-for="spec, index in specs" :key="index">
                        <span class="is-size-7 mr-3">{$ spec.spec $}:</span>
                        <b-radio-button v-for="op, i in spec.options" :key="op"
                            @click.native=""
                            v-model="currentOps[index]"
                            :native-value="op"
                            size="is-small"
                            class="mr-2 is-radiusless is-shadowless"
                            type="is-danger is-light is-outlined">
                            <span>{$ op $}</span>
                        </b-radio-button>
                    </div>
                </div> 
            </div>

            <!-- 数量 -->
            <div class="box is-flex is-align-items-center is-radiusless is-shadowless is-marginless">
                <div class="is-size-7 mr-3">数量:</div>
                <div>
                    <b-field>
                        <b-numberinput 
                            controls-position="compact" 
                            min="1" 
                            :max="goods.stock" 
                            v-model="num"
                            size="is-small"
                            :editable="false">
                        </b-numberinput> 
                    </b-field>
                </div>
                <div class="ml-3">(库存{$ goods.stock $})</div>
            </div>

            <!-- 操作 -->
            <div class="buttons box is-radiusless">
                <b-button 
                    type="is-primary" 
                    @click="" 
                    :disabled="goods.stock ? false : true ">加入购物车
                </b-button>
                <b-button 
                    type="is-primary" 
                    :disabled="goods.stock ? false : true " 
                    @click=""
                    outlined>
                    立即购买
                </b-button>
            </div>
        </div>
        <div class="column is-2">
            asda
        </div>
    </div>
</div>
{% endblock %}

{% block vue %}
    <script>
        var skus = JSON.parse(document.getElementById('skus-data').textContent);
        var specs = JSON.parse(document.getElementById('specs-data').textContent);
        var currentOps = JSON.parse(document.getElementById('current-ops-data').textContent);
        var spuDetail = new Vue({
            el: '#spuDetail',
            delimiters: ['{$', '$}'],
            data:{
                skus:skus,
                specs:specs,
                currentOps: currentOps,
                goods: null,
                num: 1
            },
            created(){
               this.goods = this.currentOps.length > 0 ? this.skus[this.currentOps.join(',')] : this.skus[this.currentOps]
            },
            methods: {
                getImgUrl(value) {
                    return `${value}`
                },
            },
            watch:{
                currentOps:{
                    handler: function(val, oldval){
                        let strVal = val.join();
                        goods = this.skus[strVal]
                        if (goods) {
                            this.goods = goods
                        } else {
                            this.goods.stock = 0
                        }
                    },
                    deep: true,
                }
            }
        })
    </script>
{% endblock %}
    
    
    