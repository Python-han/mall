{% extends 'baykeshop/user/profile.html' %}

{% load static shop_tags %}

{% block title %}
订单详情
{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumb is-small mt-5" aria-label="breadcrumbs">
    <ul>
        <li><a href="{% url 'baykeshop:home' %}">首页</a></li>
        <li><a href="{% url 'baykeshop:user_profile' %}">个人中心</a></li>
        <li class="is-active"><a href="#" aria-current="page">订单详情</a></li>
    </ul>
</nav>
{% endblock %}

{% block profile %}

<div id="orderStatus">
<div class="box is-shadowless has-background-light pt-6" >
    <b-steps v-model="activeStep" :has-navigation="false">
        <b-step-item label="待付款" icon="account-key" :clickable="false"></b-step-item>
        <b-step-item label="待发货" icon="car" :clickable="false"></b-step-item>
        <b-step-item label="待收货" icon="account-plus" :clickable="false"></b-step-item>
        <b-step-item label="待评价" icon="comment-plus" :clickable="false"></b-step-item>
        <b-step-item label="已完成" icon="store" :clickable="false"></b-step-item>
    </b-steps>
</div>

<div class="box is-shadowless has-background-light">
    <h1 class="is-size-4">订单信息</h1>
    <div class="dropdown-divider"></div>
    <div style="line-height: 2.5em;">
        <p>订单编号：{{ order.order_sn }}</p>
        {% if order.trade_sn %}
        <p>交易编号：{{ order.trade_sn }}</p>
        {% endif %}
        <p>订单日期：{{ order.add_date }}</p>
        <p>支付状态：{{ label }}</p>  
        {% if order.get_pay_method_display %}
        <p>支付方式：{{ order.get_pay_method_display }}</p>
        {% endif %}
        <p>订单金额：¥{{ order.total_amount }}</p>
        <p>订单留言：{{ order.order_mark }}</p>
    </div>
</div>

<div class="box is-shadowless has-background-light">
    <h1 class="is-size-4">收货信息</h1>
    <div class="dropdown-divider"></div>
    <div style="line-height: 2.5em;">
        <p>收货人：{{ order.name }}</p>
        <p>联系电话：{{ order.phone }}</p>
        <p>收货地址：{{ order.address }}</p>
    </div>
</div>

<div class="box is-shadowless has-background-light">
    <h1 class="is-size-4">商品信息</h1>
    <div class="dropdown-divider"></div>
    {% for order_sku in order.baykeshopordersku_set.all %}
    <article class="media">
        <figure class="media-left">
            <p class="image is-128x128">
                <img src="{{ MEDIA_URL }}{{ order_sku.sku.cover_pic }}">
            </p>
        </figure>
        <div class="media-content pr-6">
            <div class="pt-1 is-flex is-flex-direction-column is-justify-content-space-around">
                <h1>{{ order_sku.title}}</h1>
                <div class=" is-flex is-justify-content-space-between mt-2">
                    <span class="has-text-grey-light">{{ order_sku.spec }}</span>
                    <span>x{{ order_sku.count }}</span>
                </div>
                <span class="mt-3 has-text-danger-dark">¥{{ order_sku.price }}</span>
            </div>
        </div>
        <div class="media-right">
            {% if not order_sku.is_commented and order.pay_status == 4 %}
                <button 
                    class="button is-primary is-small is-outlined" 
                    @click="orderCommentModal('{{ order_sku.id }}', '{{ order.id }}')">
                    去评价
                </button>
            {% endif %}
        </div>
    </article>
    {% endfor %}
    <div class=" dropdown-divider"></div>
    <div class="has-text-right pt-3 pb-3">
        共{% order_num order.baykeshopordersku_set.all %}件商品，总金额 ¥{{ order.total_amount }}
        (含运费0.00)</div>
    <div class="buttons is-marginless is-justify-content-end is-align-items-center">
        {% if order.pay_status == 1 %}
        {% comment %} <a href="" class="button is-primary is-outlined">取消订单</a> {% endcomment %}
        <a href="{% url 'baykeshop:order_pay' %}?orderID={{ order.id }}" class="button is-primary">立即支付</a>
        {% endif %}
        {% if order.pay_status == 3 %}
        <button class="button is-primary" @click="sureOrder('{{ order.id }}', `{% url 'baykeshop:user_orders_detail' order.id %}`)">确认收货</button>
        {% endif %}
        
    </div>
    <div class=" dropdown-divider"></div>
</div>
</div>
{% endblock %}


{% block vuescript %}
{% include 'baykeshop/user/comment_form.html' %}

<script>
    var orderStatus = new Vue({
        el: '#orderStatus',
        delimiters: ['{$', '$}'],
        data: {
            activeStep: 0,
            formProps:{
                order_id: '',
                ordersku_id: ''
            }
        },
        created() {
            this.orderStatusMethod()
        },
        methods: {
            getCookie(name) {
                var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
                return r ? r[1] : undefined;
            },
            toastMessage(type, message){
                return this.$buefy.toast.open({
                    message: message,
                    type: type
                })
            },
            orderStatusMethod() {
                switch (Number('{{ order.pay_status }}')) {
                    case 1:
                        this.activeStep = 0;
                        break;
                    case 2:
                        this.activeStep = 1;
                        break;
                    case 3:
                        this.activeStep = 2;
                        break;
                    case 4:
                        this.activeStep = 3;
                        break;
                    case 5:
                        this.activeStep = 4;
                        break;
                }
            },

            // 确认收货
            sureOrder(id, url){
                const sendData = new URLSearchParams()
                sendData.append('order_id', id)
                sendData.append('ate', 'ATE')
                axios({
                    method: 'post',
                    url: url,
                    data: sendData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': this.getCookie('csrftoken'),
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    }
                }).then(res => {
                    if (res.data.code == 'ok'){
                        this.toastMessage('is-success', res.data.message)
                        location.reload()
                    }else{
                        this.toastMessage('is-danger', "发生错误，请联系管理员！")
                    }
                })
            },

            // 评论表单
            orderCommentModal(order_sku, order_id){
                this.$buefy.modal.open({
                    parent: this,
                    component: orderCommentModalForm,
                    hasModalCard: true,
                    customClass: 'custom-class custom-class-2',
                    trapFocus: true,
                    events:{
                        'saveComment': this.saveComment
                    }
                })
                this.formProps.ordersku_id = order_sku
                this.formProps.order_id = order_id
            },
            
            //评论提交
            saveComment(formProps){
                order_id = this.formProps.order_id
                ordersku_id = this.formProps.ordersku_id
                const sendData = new URLSearchParams()
                sendData.append('order_id', order_id)
                sendData.append('ordersku_id', ordersku_id)
                sendData.append('content', formProps.content)
                sendData.append('comment_choices', formProps.radio)
                sendData.append('user_id', formProps.user_id)
                
                axios({
                    method: 'post',
                    url: '{{ request.path }}',
                    data: sendData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': this.getCookie('csrftoken'),
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    }
                }).then(res => {
                    if (res.data.code == 'ok'){
                        this.toastMessage('is-success', res.data.message)
                        location.reload()
                    }else{
                        this.toastMessage('is-danger', "发生错误，请联系管理员！")
                    }
                })
            }

        }
    })
</script>
{% endblock %}