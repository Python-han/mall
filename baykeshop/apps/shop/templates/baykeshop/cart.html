{% extends 'baykeshop/base_site.html' %}

{% load i18n static %}

{% block title %}购物车{% endblock %}

{% block extrastyle %}{{ block.super }}
<style>
    .table td {
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<div class="container">
    <nav class="breadcrumb is-marginless mt-3 mb-3 is-small" aria-label="breadcrumbs">
      <ul>
        <li><a href="{% url 'shop:home' %}">首页</a></li>
        <li class="is-active"><a href="#" aria-current="page">购物车</a></li>
      </ul>
    </nav>
</div>
{% endblock %}

{% block container %}
{{ results|json_script:"carts-data" }}

<div id="carts">
    <div class="box is-radiusless" v-if="cartsData.length > 0">
        <template>
            <b-table
                checkable
                hoverable
                :is-row-checkable="(row) => Number(row.skuData.stock) > Number(row.num)"
                :checked-rows.sync="checkedRows" 
                :data="cartsData">
                <b-table-column field="id" label="ID" v-slot="props">
                    {$ props.row.id $}
                </b-table-column>
                <b-table-column field="pic" label="商品图" v-slot="props">
                    <figure class="image is-128x128">
                        <b-image
                            :src="`${props.row.skuData.img}`"
                            :alt="props.row.skuData.spu.title"
                            ratio="1by1"
                        ></b-image>
                    </figure>
                </b-table-column>
                <b-table-column field="title" label="标题" v-slot="props">
                    {$ props.row.skuData.spu.title $}
                    <div class="is-flex">
                        <p class="mt-2 mr-3" v-for="spec, i in props.row.skuData.options" :key="i">
                            <span class=" has-text-grey-light">
                                {$ spec.spec__name $}
                            </span>：<strong>{$ spec.value $}</strong> 
                        </p>
                    </div>
                </b-table-column>
                <b-table-column field="stock" label="库存" width="120" v-slot="props">
                    {$ props.row.skuData.stock $}
                </b-table-column>
                <b-table-column field="price" label="单价" width="120" v-slot="props">
                    <span class="is-size-5 has-text-grey">¥</span>{$ props.row.skuData.price $}
                </b-table-column>
                <b-table-column field="count" label="数量" v-slot="props">
                    <b-field>
                        <b-numberinput
                            @input="updateCartNum(props.row)"
                            controls-position="compact"
                            size="is-small"
                            type="is-light"
                            :min="1"
                            :max="props.row.skuData.stock"
                            :editable='true'
                            v-model="props.row.num">
                        </b-numberinput>
                    </b-field>
                </b-table-column>
                <b-table-column field="total_price" label="小计" width="120" v-slot="props">
                    <span class="is-size-5 has-text-grey">¥</span>{$ parseFloat(props.row.skuData.price * props.row.num).toFixed(2) $}
                </b-table-column>
                <b-table-column field="caozuo" label="操作" width="80" v-slot="props">
                    <button class="delete" @click="delCart(props.row)">删除</button>
                </b-table-column>

                <template #footer>
                    <div class="has-background-light is-flex is-align-items-center is-justify-content-space-between">
                        <div class="has-text-danger-dark ml-3">
                            已选<span class="is-size-4 pl-2 pr-2">{$ checkedRows.length $}</span>件商品 
                        </div>
                        <div class=" is-flex is-align-items-center has-text-danger-dark ">
                            <span class="is-size-5">合计：</span> <span class="is-size-3 pr-5">¥ {$ total $}</span>
                            <button 
                                class="button is-primary is-radiusless is-large pl-6 pr-6" 
                                :disabled="checkedRows.length > 0 ? false : true"
                                @click="cartBuy">
                                去结算
                            </button>
                        </div>
                    </div>
                </template>
            </b-table>
        </template>
    </div>
    <div class="has-text-centered has-text-danger is-size-5" v-else> 
        <img src="{% static 'baykeshop/img/noCart1.png' %}">
        <p> 亲，购物车还是空的哟~ </p>
        <a class=" button is-primary is-outlined mt-4" href="{% url 'shop:home' %}">继 续 逛</a>
    </div>

</div>

{% endblock %}


{% block vue %}
    <script>
        var cartsData = JSON.parse(document.getElementById('carts-data').textContent);
        
        var carts = new Vue({
            el: '#carts',
            delimiters: ['{$', '$}'],
            data: {
                cartsData,
                checkedRows: [],  // 选择的动态
                total:0
            },
            created(){
                cartsData.forEach(item => {
                    if (item.num < item.skuData.stock){
                        this.checkedRows.push(item)
                    }
                })
            },
            watch:{
               // 监听选中商品
               checkedRows: {
                    handler: function (rows, oldrows) {
                        let total = 0;
                        rows.forEach(row => {
                            total += row.skuData.price * row.num
                        })
                        this.total = total.toFixed(2)
                    },
                    immediate: true,
                    deep: true
                },

            },
            methods: {
                // 修改数量
                updateCartNum(row){
                    request({
                        url: `/api/shop/cart/${row.id}/`,
                        method: 'patch',
                        data: {
                            num: row.num
                        }
                    }).then(res => {
                        if (res.status == 200) {
                            bayke._data.cartcount = res.data.num
                            bayke.toastMessage('is-success', '修改成功！')
                        }
                    })
                },

                // 删除购物车
                delCart(row){
                    this.$buefy.dialog.confirm({
                        message: '是否确认删除该购物车商品！',
                        cancelText: '取消',
                        onConfirm: () => {
                            request({
                                url: `/api/shop/cart/${row.id}/`,
                                method: 'delete',
                            }).then(res => {
                                if (res.status == 204){
                                    // 前端删除数组
                                    this.cartsData.forEach(item => {
                                        if (item.id == row.id){
                                            this.cartsData.splice(this.cartsData.indexOf(item), 1)
                                            this.checkedRows.splice(this.checkedRows.indexOf(item), 1)
                                            bayke._data.cartcount = parseInt(bayke._data.cartcount) - parseInt(row.num)
                                        }
                                    })
                                    bayke.toastMessage('is-success', '删除成功！')
                                }
                            })
                        }
                    })
                },

                // 购物车结算
                cartBuy(){
                    let cartids = []
                    let baykeshopordersku_set = []
                    this.checkedRows.forEach(el => {
                        cartids.push(el.id)
                        sku_dict = {
                            sku: el.sku,
                            count: el.num
                        }
                        baykeshopordersku_set.push(sku_dict)
                    })
                    request({
                        url: '{% url "shop:order-create" %}',
                        method: 'post',
                        data: {
                            baykeshopordersku_set: baykeshopordersku_set,
                            total_price: 0
                        }
                    }).then(res => {
                        if (res.status == 201){
                            this.delCarts(cartids)
                            location.replace(`/order/${res.data.id}/confirm/`)
                        }else{
                            console.error(res)
                            bayke.toastMessage('is-error', '订单创建失败，请检查')
                        }
                    })
                },
                // 批量删除购物车
                delCarts(ids){
                    request({
                        url: '{% url "shop_api:cart-batch-destroy" %}',
                        method: 'delete',
                        data: {ids: ids}
                    }).then(res => {
                        if (res.status == 204){
                            console.log('购物车删除成功')
                        }else{
                            console.error(res)
                            bayke.toastMessage('is-error', '购物车删除失败')
                        }
                    })
                }
            }
        })

    </script>
{% endblock %}