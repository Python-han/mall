{% extends 'baykeShop/goods.html' %}

{% load i18n static %}

{% block title %}购物车{% endblock %}

{% block extrastyle %}{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
    .table td {
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block banner %}{% endblock %}

{% block breadcrumbs %}
    <div class="breadcrumbs pt-3 pb-3">
        <a class="has-text-grey-dark" href="{% url 'baykeShop:home' %}">首页</a>
        &rsaquo; <span class=" has-text-grey-lighter">购物车</span> 
    </div>
{% endblock %}

{% block content %}
{{ carts|json_script:"carts-data" }}
<div id="cart" class="mb-5" style="min-height: 60vh;">
    <div class="box">
        <template>
            <b-table
                checkable
                hoverable
                :is-row-checkable="(row) => Number(row.stock) > Number(row.sales)"
                :checked-rows.sync="checkedRows" 
                :data="carts">
                <b-table-column field="id" label="ID" v-slot="props">
                    {$ props.row.id $}
                </b-table-column>
                
                <b-table-column field="cover_pic" label="商品图" v-slot="props">
                    <figure class="image is-128x128">
                        <b-image
                            :src="`/media/${props.row.cover_pic}`"
                            :alt="props.row.title"
                            ratio="1by1"
                        ></b-image>
                    </figure>
                </b-table-column>

                <b-table-column field="title" label="标题" v-slot="props">
                    {$ props.row.title $}
                    <div class="is-flex">
                        <p class="mt-2 mr-3" v-for="spec, i in props.row.options" :key="i">
                            <span class=" has-text-grey-light">
                                {$ spec.spec__name $}
                            </span>：<strong>{$ spec.name $}</strong> 
                        </p>
                    </div>
                </b-table-column>

                <b-table-column field="stock" label="库存" width="120" v-slot="props">
                    {$ props.row.stock $}
                </b-table-column>

                <b-table-column field="price" label="单价" width="120" v-slot="props">
                    <span class="is-size-5 has-text-grey">¥</span>{$ props.row.price $}
                </b-table-column>

                <b-table-column field="sales" label="数量" v-slot="props">
                    <b-field>
                        <b-numberinput
                            @input="salesActions(props.row)"
                            controls-position="compact"
                            size="is-small" 
                            type="is-light"
                            :min="1"
                            :max="props.row.stock"
                            :editable='true'
                            v-model="props.row.sales">
                        </b-numberinput>
                    </b-field>
                </b-table-column>

                <b-table-column field="total_price" label="小计" width="120" v-slot="props">
                    <span class="is-size-5 has-text-grey">¥</span>{$ props.row.total_price $}
                </b-table-column>

                <b-table-column field="caozuo" label="操作" width="80" v-slot="props">
                    <button class="delete" @click="updateCart(props.row.id)">删除</button>
                </b-table-column>

                <template #footer>
                    <div class="has-background-light is-flex is-align-items-center is-justify-content-space-between">
                        <div class="has-text-danger-dark ml-3">
                            已选<span class="is-size-4 pl-2 pr-2">{$ checkedRows.length $}</span>件商品 
                        </div>
                        <div class=" is-flex is-align-items-center">
                            <span>合计：</span> <span class="is-size-4 pr-5">¥ {$ total $}</span>
                            <a class="button is-primary is-radiusless is-large pl-6 pr-6" href="">去结算</a>
                        </div>
                        <!-- <div>{$ checkedRows $}</div> -->
                    </div>
                </template>
            </b-table>
        </template>
    </div>
</div>
{% endblock %}


{% block vuescript %}
    <script>
        var carts = JSON.parse(document.getElementById('carts-data').textContent);

        var cart = new Vue({
            el: '#cart',
            delimiters: ['{$', '$}'],
            data: {
                carts: carts,
                checkedRows: [],
                total: 0,
            },
            created(){
                carts.forEach(row => {
                    if (Number(row.stock) > Number(row.sales)){
                        this.checkedRows.push(row)
                        this.total += parseFloat(row.total_price).toFixed(2)
                    }
                })
            },
            methods: {
                getCookie(name) {
                    var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
                    return r ? r[1] : undefined;
                },
                toastMessage(type, message){
                    return this.$buefy.toast.open({
                        message: message,
                        type: type
                    })
                },
                // 数量变化时价格跟随变化
                salesActions(data){
                    data.total_price = parseFloat(data.sales * data.price).toFixed(2)
                },
                // 删除购物车
                updateCart(cart_id){
                    const sendData = new URLSearchParams();
                    sendData.append('cart_id', cart_id)
                    axios({
                        method: 'put',
                        url: '{% url "baykeShop:cart" %}',
                        data: sendData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': this.getCookie('csrftoken'),
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                        }
                    }).then(res => {
                        console.log(res)
                    })
                }
            },
            watch: {
                // 监听选中商品
                checkedRows: {
                    handler: function (rows, oldrows) {
                        let total = 0;
                        rows.forEach(row => {
                            total += parseFloat(row.total_price)
                        })
                        this.total = total.toFixed(2)
                    },
                    deep: true
                }
            }
        })
    </script>
{% endblock %}
    