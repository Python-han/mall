{% extends 'baykeShop/goods.html' %}

{% load i18n static %}

{% block title %}购物车{% endblock %}

{% block extrastyle %}{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
    .table td {
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block banner %}{% endblock %}

{% block breadcrumbs %}
    <nav class="breadcrumb is-small mt-5" aria-label="breadcrumbs">
        <ul>
          <li><a href="{% url 'baykeShop:home' %}">首页</a></li>
          <li><a href="#">用户中心</a></li>
          <li class="is-active"><a href="#" aria-current="page">购物车</a></li>
        </ul>
    </nav>
{% endblock %}

{% block content %}
{{ carts|json_script:"carts-data" }}
<div id="cart" class="mb-5" style="min-height: 60vh;">
    <div class="box is-marginless" v-if="carts.length > 0">
        <template>
            <b-table
                checkable
                hoverable
                :is-row-checkable="(row) => Number(row.stock) > Number(row.sales)"
                :checked-rows.sync="checkedRows" 
                :data="carts">
                <b-table-column field="id" label="ID" v-slot="props">
                    {$ props.row.id $}
                </b-table-column>
                
                <b-table-column field="cover_pic" label="商品图" v-slot="props">
                    <figure class="image is-128x128">
                        <b-image
                            :src="`/media/${props.row.cover_pic}`"
                            :alt="props.row.title"
                            ratio="1by1"
                        ></b-image>
                    </figure>
                </b-table-column>

                <b-table-column field="title" label="标题" v-slot="props">
                    {$ props.row.title $}
                    <div class="is-flex">
                        <p class="mt-2 mr-3" v-for="spec, i in props.row.options" :key="i">
                            <span class=" has-text-grey-light">
                                {$ spec.spec__name $}
                            </span>：<strong>{$ spec.name $}</strong> 
                        </p>
                    </div>
                </b-table-column>

                <b-table-column field="stock" label="库存" width="120" v-slot="props">
                    {$ props.row.stock $}
                </b-table-column>

                <b-table-column field="price" label="单价" width="120" v-slot="props">
                    <span class="is-size-5 has-text-grey">¥</span>{$ props.row.price $}
                </b-table-column>

                <b-table-column field="sales" label="数量" v-slot="props">
                    <b-field>
                        <b-numberinput
                            @input="salesActions(props.row)"
                            controls-position="compact"
                            size="is-small" 
                            type="is-light"
                            :min="1"
                            :max="props.row.stock"
                            :editable='true'
                            v-model="props.row.sales">
                        </b-numberinput>
                    </b-field>
                </b-table-column>

                <b-table-column field="total_price" label="小计" width="120" v-slot="props">
                    <span class="is-size-5 has-text-grey">¥</span>{$ props.row.total_price $}
                </b-table-column>

                <b-table-column field="caozuo" label="操作" width="80" v-slot="props">
                    <button class="delete" @click="updateCart(props.row.id)">删除</button>
                </b-table-column>

                <template #footer>
                    <div class="has-background-light is-flex is-align-items-center is-justify-content-space-between">
                        <div class="has-text-danger-dark ml-3">
                            已选<span class="is-size-4 pl-2 pr-2">{$ checkedRows.length $}</span>件商品 
                        </div>
                        <div class=" is-flex is-align-items-center has-text-danger-dark ">
                            <span class="is-size-5">合计：</span> <span class="is-size-3 pr-5">¥ {$ total $}</span>
                            <button class="button is-primary is-radiusless is-large pl-6 pr-6" :disabled="checkedRows.length > 0 ? false : true"
                                v-on:click.capture="doThis">
                                去结算
                            </button>
                        </div>
                        <!-- <div>{$ checkedRows $}</div> -->
                    </div>
                </template>
            </b-table>
        </template>
    </div>
    <div class="has-text-centered has-text-danger is-size-5" v-else> 
        <img src="{% static 'baykeShop/img/noCart1.png' %}">
        <p> 亲，购物车还是空的哟~ </p>
        <a class=" button is-primary is-outlined mt-4" href="{% url 'baykeShop:home' %}">继 续 逛</a>
    </div>
</div>
{% endblock %}


{% block vuescript %}
    <script>
        var carts = JSON.parse(document.getElementById('carts-data').textContent);

        var cart = new Vue({
            el: '#cart',
            delimiters: ['{$', '$}'],
            data: {
                carts: carts,
                checkedRows: [],
                total: 0,
                checkedRowsCartID:''
            },
            created(){
                // 第一次加载时处理库存不足的选中数据
                carts.forEach(row => {
                    if (Number(row.stock) > Number(row.sales)){
                        this.checkedRows.push(row)
                        this.total += parseFloat(row.total_price).toFixed(2)
                    }
                })
            },
            methods: {
                // 获取cookie
                getCookie(name) {
                    var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
                    return r ? r[1] : undefined;
                },
                // 消息提示
                toastMessage(type, message){
                    return this.$buefy.toast.open({
                        message: message,
                        type: type
                    })
                },
                // 数量变化时价格跟随变化
                salesActions(data){
                    data.total_price = parseFloat(data.sales * data.price).toFixed(2)
                    // 更改数据库
                    const sendData = new URLSearchParams();
                    sendData.append('sales', Number(data.sales));
                    sendData.append('cart_id', Number(data.id));
                    sendData.append('actions', 'update_num')
                    axios({
                        method: 'put',
                        url: '{% url "baykeShop:cart" %}',
                        data: sendData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': this.getCookie('csrftoken'),
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                        }
                    }).then(res => {
                        if (res.data.code == 'ok'){
                            this.toastMessage('is-success', res.data.message)
                        }else{
                            this.toastMessage('is-danger', res.data.message)
                        }
                    })
                },
                // 删除购物车
                updateCart(cart_id){
                    const sendData = new URLSearchParams();
                    sendData.append('cart_id', cart_id)
                    sendData.append('actions', 'delete')
                    this.$buefy.dialog.confirm({
                        message: '是否确认删除该购物车商品！',
                        cancelText: '取消',
                        onConfirm: () => {
                            axios({
                                method: 'put',
                                url: '{% url "baykeShop:cart" %}',
                                data: sendData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'X-CSRFToken': this.getCookie('csrftoken'),
                                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                                }
                            }).then(res => {
                                if (res.data.code == 'ok'){

                                    // 修改头部购物车数量
                                    let cartNum = Number(headTop._data.cartNum)
                                    headTop._data.cartNum = cartNum - 1

                                    // 删除购物车列表中的显示数据
                                    this.carts.forEach(row => {
                                        if (Number(cart_id) == Number(row.id)){
                                            this.carts.splice(this.carts.indexOf(row), 1);
                                            this.checkedRows.splice(this.checkedRows.indexOf(row), 1);
                                        }
                                    })

                                    // 弹出提示
                                    this.toastMessage('is-success', res.data.message)

                                }else{
                                    this.toastMessage('is-danger', res.data.message)
                                }
                            })
                        }
                    })
                },

                // 去结算事件
                doThis(){
                    // 结算时将选中商品信息存储到本地
                    if (this.checkedRows.length > 0){
                        localStorage.setItem('carts', JSON.stringify(this.checkedRows))
                        location.href = "{% url 'baykeShop:order_confirm' %}"
                    }
                }
            },
            watch: {
                // 监听选中商品
                checkedRows: {
                    handler: function (rows, oldrows) {
                        let total = 0;
                        rows.forEach(row => {
                            total += parseFloat(row.total_price)
                        })
                        this.total = total.toFixed(2)
                    },
                    deep: true
                }
            }
        })
    </script>
{% endblock %}
    